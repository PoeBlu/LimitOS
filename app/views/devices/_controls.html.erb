<%= stylesheet_link_tag 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.2/css/bootstrap-slider.min.css' %>
<%= javascript_include_tag 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.2/bootstrap-slider.min.js' %>

Status: <span id="device_status"></span>

<br><br>

<% @device.pins.where(pin_type: 'digital').order("pin_number asc").each do |pin| %>
  <div class="well">
    <%= pin.name %> (pin number: <%= pin.pin_number %>)
    <button class="on_button">On</button>
    <button class="off_button">Off</button>
    <br>
  </div>
<% end %>

<br>

<% @device.pins.where(pin_type: 'servo').order("pin_number asc").each do |pin| %>
  <div class="well">
    <%= pin.name %> (pin number: <%= pin.pin_number %>)
    <form id="servo_form">
      <input id="servo_input" placeholder="Servo position"></input>
      <button id="servo_button">Submit</button>
      <br><br>
      <input id="slider_<%= pin.pin_number %>" data-slider-id='servo_slider' type="text" data-slider-min="0" data-slider-max="90" data-slider-step="1" data-slider-value="0" />
    </form>
  </div>
<% end %>

<script>

  <% @device.pins.where(pin_type: 'servo').each do |pin| %>
    // initialize this slider
    var slider_<%= pin.pin_number %> = new Slider("#slider_<%= pin.pin_number %>", {
      formatter: sliderFormatter
    });
  <% end %>

  // format slider tooltip
  function sliderFormatter(value) {
    return 'Current value: ' + value;
  }

  // when the document is ready
  $(document).ready(function() {

    <% @device.pins.where(pin_type: 'servo').each do |pin| %>
      // when the slider is moved
      slider_<%= pin.pin_number %>.on('slide', function() {
        // get the slider value
        var value = slider_<%= pin.pin_number %>.getValue();
        // send the value
        $.post('/devices/send_message', {
          message: { servo: value }
        });
      });
    <% end %>

    // when the on button is clicked
    $('.on_button').click(function() {
      console.log('on button clicked');
      $.post('/devices/send_message', { message: { value: 'on' } });
    });

    // when the off button is clicked
    $('.off_button').click(function() {
      console.log('off button clicked');
      $.post('/devices/send_message', { message: { value: 'off' } });
    });

    // when the servo form is submitted
    $('#servo_form').submit(function() {
      sendServoMessage();
      // don't reload the page
      return false;
    });

    // subscribe to 'X'
    App.cable.subscriptions.create('DevicesChannel', {
      // when data is received
      received: function(data) {
        // log the data
        console.log(data);
        // update the status
        $('#device_status').text(JSON.stringify(data));
      }
    });

  });

  // send servo position
  function sendServoMessage() {
    $.post('/devices/send_message', {
      message: { servo: $('#servo_input').val() }
    });
  }
</script>

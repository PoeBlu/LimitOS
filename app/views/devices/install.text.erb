#!/usr/bin/env bash
# the preceding line instructs this script to run using the bash interpreter

# main function definition
perform_install()
{
  echo 'starting installation...'

  # create a new device and return the auth_token
  device_json=$(curl -sSL -X POST <%= full_url %>/api/v1/devices)

  # get the device id from the JSON
  device_id=$(echo $device_json | grep -Po '"id":(\d*)' | awk -F':' '{print $2}')

  # get the auth token from the JSON
  device_auth_token=$(echo $device_json | grep -Po '"auth_token":.*?[^\\]"' | awk -F':' '{print $2}' | tr -d '"')

  # get a new registration code (using the device auth_token)
  registration_json=$(curl -sSL --data "auth_token=$device_auth_token" http://localhost:3000/api/v1/devices/$device_id/registrations)

  # get the auth token from the JSON
  registration_auth_token=$(echo $registration_json | grep -Po '"auth_token":.*?[^\\]"' | awk -F':' '{print $2}' | tr -d '"')

  # download the client.js file
  download_client_js 

  # output the registration information
  echo "register using the following code (valid for the next 5 minutes): $registration_auth_token"
}

# function to download client.js
function download_client_js()
{
  echo "download_client_js for device id: $device_id"

  # retrieve client.js script

  # save client.js
}

# run the main function
perform_install
